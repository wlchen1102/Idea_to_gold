(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[558],{283:(e,t,r)=>{"use strict";r.d(t,{As:()=>i,AuthProvider:()=>o,XI:()=>c});var a=r(5155),s=r(2115),n=r(2099);let l=(0,s.createContext)(void 0);function o(e){let{children:t}=e,[r,o]=(0,s.useState)({user:null,authUser:null,session:null,loading:!0,token:null,userId:null}),i=async e=>{try{let t=await fetch("/api/users/me/profile",{headers:{Authorization:"Bearer ".concat(e),"Cache-Control":"no-cache"},cache:"no-store"});if(!t.ok)return console.warn("获取用户资料失败:",t.status,t.statusText),null;return(await t.json()).profile}catch(e){return console.warn("获取用户资料异常:",e),null}},c=(0,s.useCallback)(async e=>{var t;let r=null;if((null==e?void 0:e.user)&&(null==e?void 0:e.access_token)){if(!(r=await i(e.access_token))){console.warn("用户资料获取失败，可能token已过期，清理认证状态"),localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userId"),o({user:null,authUser:null,session:null,loading:!1,token:null,userId:null});return}}else localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userId");o({user:r,authUser:(null==e?void 0:e.user)||null,session:e,loading:!1,token:(null==e?void 0:e.access_token)||null,userId:(null==e||null==(t=e.user)?void 0:t.id)||null})},[]),u=async()=>{try{let e=(0,n.$)(),{data:{session:t},error:r}=await e.auth.getSession();if(r){console.warn("获取认证状态失败:",r),await c(null);return}await c(t)}catch(e){console.warn("刷新认证状态异常:",e),await c(null)}},d=async()=>{try{let e=(0,n.$)();await e.auth.signOut(),await c(null),localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userId")}catch(e){console.warn("登出失败:",e)}};(0,s.useEffect)(()=>{let e=!0,t=null,r=null,a=null;return(async()=>{try{let a=(0,n.$)(),{data:{session:s},error:l}=await a.auth.getSession();l&&console.warn("初始化认证状态失败:",l),e&&await c(s);let{data:u}=a.auth.onAuthStateChange(async(t,r)=>{e&&(await c(r),(null==r?void 0:r.user)?(localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userId",r.user.id)):(localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userId")))});return t=u,r=async()=>{if(e)try{let{data:{session:t}}=await a.auth.getSession();if(null==t?void 0:t.access_token){let r=await i(t.access_token);e&&o(e=>({...e,user:r}))}}catch(e){console.warn("更新用户资料失败:",e)}},window.addEventListener("auth:changed",r),()=>{if(e=!1,t)try{t.subscription.unsubscribe()}catch(e){console.warn("取消认证监听器失败:",e)}r&&window.removeEventListener("auth:changed",r)}}catch(t){console.warn("认证初始化异常:",t),e&&o(e=>({...e,loading:!1}))}})().then(e=>{a=e||null}).catch(e=>{console.warn("认证初始化失败:",e)}),()=>{if(e=!1,a)a();else{if(t)try{t.subscription.unsubscribe()}catch(e){console.warn("取消认证监听器失败:",e)}r&&window.removeEventListener("auth:changed",r)}}},[c]);let m={...r,refreshAuth:u,logout:d,signOut:d};return(0,a.jsx)(l.Provider,{value:m,children:t})}function i(){let e=(0,s.useContext)(l);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function c(){let{authUser:e,loading:t}=i();return!t&&!!e}},347:()=>{},1666:e=>{e.exports={style:{fontFamily:"'Inter', 'Inter Fallback'",fontStyle:"normal"},className:"__className_e8ce0c",variable:"__variable_e8ce0c"}},2099:(e,t,r)=>{"use strict";r.d(t,{$:()=>o});var a=r(2354);let s="https://bkvbvmgcqfnxokklsxus.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdmJ2bWdjcWZueG9ra2xzeHVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3OTExNjIsImV4cCI6MjA3MDM2NzE2Mn0.uNkB5g0owHKEumiPDzek1K0ZaSDdIJhPT6FwHh0hmJ0",l=s&&n?(0,a.UU)(s,n):null;function o(){if(!s||!n)throw Error("缺少 Supabase 前端环境变量，请配置以下任一组合：\n1) NEXT_PUBLIC_SUPABASE_URL 和 NEXT_PUBLIC_SUPABASE_ANON_KEY\n或\n2) VITE_SUPABASE_URL 和 VITE_SUPABASE_ANON_KEY");if(!l)throw Error("Supabase 客户端未初始化，请刷新页面或检查环境变量");return l}},2731:(e,t,r)=>{"use strict";r.d(t,{A:()=>s});var a=r(5155);function s(e){let{size:t="md",className:r=""}=e;return(0,a.jsx)("div",{className:"inline-block animate-spin rounded-full border-gray-200 border-t-emerald-500 ".concat({sm:"h-8 w-8 border-2",md:"h-14 w-14 border-3",lg:"h-24 w-24 border-4"}[t]," ").concat(r)})}},2763:(e,t,r)=>{"use strict";r.d(t,{LoadingProvider:()=>i});var a=r(5155),s=r(2115),n=r(5695),l=r(2731);let o=(0,s.createContext)(void 0);function i(e){let{children:t}=e,[r,l]=(0,s.useState)(!1),[i,u]=(0,s.useState)(void 0),d=(0,n.usePathname)(),m=e=>{l(e),e||u(void 0)};return(0,s.useEffect)(()=>{if(r){let e=setTimeout(()=>{m(!1)},100);return()=>clearTimeout(e)}},[d,r]),(0,a.jsxs)(o.Provider,{value:{isLoading:r,setLoading:m,loadingText:i,setLoadingText:u},children:[t,r&&(0,a.jsx)(c,{text:i})]})}function c(e){let{text:t}=e;return(0,a.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/20 backdrop-blur-sm",children:(0,a.jsx)("div",{className:"rounded-2xl bg-white p-8 shadow-2xl",children:(0,a.jsxs)("div",{className:"flex flex-col items-center space-y-4",children:[(0,a.jsx)(l.A,{size:"lg"}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"text-lg font-medium text-[#2c3e50]",children:t||"正在加载..."}),(0,a.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"请稍候片刻"})]})]})})})}},5369:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});var a=r(5155),s=r(2115);function n(){let[e,t]=(0,s.useState)("");return((0,s.useEffect)(()=>{let e="pendingToast";function r(){let r=localStorage.getItem(e);r&&(t(r),localStorage.removeItem(e),setTimeout(()=>t(""),2500))}r();let a=t=>{t.key===e&&t.newValue&&r()},s=()=>{r()};return window.addEventListener("storage",a),window.addEventListener("localToast",s),()=>{window.removeEventListener("storage",a),window.removeEventListener("localToast",s)}},[]),e)?(0,a.jsx)("div",{className:"pointer-events-none fixed top-1/4 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[60]",children:(0,a.jsxs)("div",{className:"pointer-events-auto flex items-center gap-2 rounded-lg bg-gray-900/90 px-4 py-2 text-sm text-white shadow-lg",children:[(0,a.jsx)("span",{"aria-hidden":!0,children:"\uD83D\uDE80"}),(0,a.jsx)("span",{children:e})]})}):null}},5695:(e,t,r)=>{"use strict";var a=r(8999);r.o(a,"useParams")&&r.d(t,{useParams:function(){return a.useParams}}),r.o(a,"usePathname")&&r.d(t,{usePathname:function(){return a.usePathname}}),r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}}),r.o(a,"useSearchParams")&&r.d(t,{useSearchParams:function(){return a.useSearchParams}})},6300:(e,t,r)=>{Promise.resolve().then(r.t.bind(r,1666,23)),Promise.resolve().then(r.t.bind(r,347,23)),Promise.resolve().then(r.bind(r,2763)),Promise.resolve().then(r.bind(r,8521)),Promise.resolve().then(r.bind(r,5369)),Promise.resolve().then(r.bind(r,283))},8521:(e,t,r)=>{"use strict";r.d(t,{default:()=>x});var a=r(5155),s=r(6874),n=r.n(s),l=r(2115),o=r(6766),i=r(283),c=r(2099);let u=new Set,d=async e=>{let t="supported-creatives:".concat(e);if(!u.has(t))try{var r,a,s;u.add(t);let n=(0,c.$)(),l=null!=(s=null==(a=(await n.auth.getSession()).data)||null==(r=a.session)?void 0:r.access_token)?s:"";if(!l)return void u.delete(t);fetch("/api/users/".concat(e,"/supported-creatives?page=1&limit=10"),{headers:{Authorization:"Bearer ".concat(l)},cache:"default"}).catch(()=>{u.delete(t)})}catch(e){u.delete(t)}},m=function(){var e;let[t,r]=(0,l.useState)(!1),{user:s,logout:c}=(0,i.As)(),u=(0,l.useRef)(null),m=async()=>{try{r(!1),await c(),window.location.href="/"}catch(e){console.error("登出失败:",e)}},h=()=>{r(!1)};return s?(0,a.jsxs)("div",{className:"relative",onMouseEnter:()=>{u.current&&(clearTimeout(u.current),u.current=null),r(!0)},onMouseLeave:()=>{u.current=setTimeout(()=>{r(!1)},150)},children:[(0,a.jsxs)("button",{className:"flex items-center gap-1.5 rounded-full bg-white px-2 py-1 shadow-sm ring-1 ring-gray-200 hover:shadow-md transition-shadow",children:[s.avatar_url?(0,a.jsx)(o.default,{src:s.avatar_url,alt:"用户头像",width:32,height:32,className:"w-8 h-8 rounded-full object-cover"}):(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white text-sm font-medium",children:(null==(e=s.nickname)?void 0:e.charAt(0).toUpperCase())||"U"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-700",children:s.nickname||"用户"})]}),t&&(0,a.jsxs)("div",{className:"absolute left-[24px] -translate-x-1/2 mt-2 inline-block w-auto rounded-lg bg-white py-1 shadow-lg ring-1 ring-gray-200 z-50",children:[(0,a.jsx)(n(),{href:"/profile/".concat(null==s?void 0:s.id,"?tab=createdIdeas"),onClick:h,onMouseEnter:()=>{(null==s?void 0:s.id)&&d(s.id)},className:"block px-6 py-1.5 text-sm text-gray-700 hover:bg-gray-50 whitespace-nowrap",children:"个人中心"}),(0,a.jsx)(n(),{href:"/projects",onClick:h,className:"block px-6 py-1.5 text-sm text-gray-700 hover:bg-gray-50 whitespace-nowrap",children:"我的项目"}),(0,a.jsx)(n(),{href:"/projects/me",onClick:h,className:"block px-6 py-1.5 text-sm text-gray-700 hover:bg-gray-50 whitespace-nowrap",children:"账户设置"}),(0,a.jsx)("button",{onClick:m,className:"block w-full px-6 py-1.5 text-left text-sm text-gray-700 hover:bg-gray-50 whitespace-nowrap",children:"退出登录"})]})]}):null};var h=r(5695);let x=function(){let e=(0,i.XI)(),t=(0,h.usePathname)(),r=e=>t===e||t.startsWith(e+"/");return(0,a.jsx)("nav",{className:"sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm",children:(0,a.jsx)("div",{className:"mx-auto max-w-7xl px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"flex h-16 items-center justify-between",children:[(0,a.jsxs)(n(),{href:"/",className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-bold text-sm",children:"点"}),(0,a.jsx)("span",{className:"text-xl font-bold text-gray-900",children:"点子成金"})]}),(0,a.jsxs)("div",{className:"hidden gap-8 md:flex",role:"navigation",children:[(0,a.jsx)(n(),{href:"/creatives",className:"text-base font-medium transition-colors px-1 pb-1 border-b-2 ".concat(r("/creatives")?"text-emerald-600 border-emerald-500":"text-gray-700 hover:text-emerald-600 border-transparent"),"aria-current":r("/creatives")?"page":void 0,children:"创意广场"}),(0,a.jsx)(n(),{href:"#",className:"text-base font-medium text-gray-700 hover:text-emerald-600 transition-colors px-1 pb-1 border-b-2 border-transparent",children:"产品广场"})]}),(0,a.jsx)("div",{className:"flex items-center gap-4",children:e?(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(m,{})}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n(),{href:"/login",className:"rounded-lg border border-gray-300 px-6 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50",children:"登录"}),(0,a.jsx)(n(),{href:"/login?mode=signup",className:"rounded-lg bg-gradient-to-r from-emerald-500 to-emerald-600 px-6 py-2 text-sm font-semibold text-white shadow-md transition-all hover:shadow-lg hover:brightness-110",children:"立即免费注册"})]})})]})})})}}},e=>{e.O(0,[258,874,354,766,441,964,358],()=>e(e.s=6300)),_N_E=e.O()}]);