(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[170],{283:(e,t,l)=>{"use strict";l.d(t,{As:()=>o,AuthProvider:()=>i,XI:()=>c});var r=l(5155),n=l(2115),a=l(2099);let s=(0,n.createContext)(void 0);function i(e){let{children:t}=e,[l,i]=(0,n.useState)({user:null,authUser:null,session:null,loading:!0,token:null,userId:null}),o=async e=>{try{let t=(0,a.$)(),{data:l,error:r}=await t.from("profiles").select("id, nickname, avatar_url").eq("id",e).single();if(r)return console.warn("获取用户资料失败:",r),null;return l}catch(e){return console.warn("获取用户资料异常:",e),null}},c=(0,n.useCallback)(async e=>{var t;let l=null;(null==e?void 0:e.user)&&(l=await o(e.user.id)),i({user:l,authUser:(null==e?void 0:e.user)||null,session:e,loading:!1,token:(null==e?void 0:e.access_token)||null,userId:(null==e||null==(t=e.user)?void 0:t.id)||null})},[]),d=async()=>{try{let e=(0,a.$)(),{data:{session:t},error:l}=await e.auth.getSession();if(l){console.warn("获取认证状态失败:",l),await c(null);return}await c(t)}catch(e){console.warn("刷新认证状态异常:",e),await c(null)}},u=async()=>{try{let e=(0,a.$)();await e.auth.signOut(),await c(null),localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userId")}catch(e){console.warn("登出失败:",e)}};(0,n.useEffect)(()=>{let e=!0,t=null;return(async()=>{try{let l=(0,a.$)(),{data:{session:r},error:n}=await l.auth.getSession();n&&console.warn("初始化认证状态失败:",n),e&&await c(r);let{data:s}=l.auth.onAuthStateChange(async(t,l)=>{e&&(await c(l),(null==l?void 0:l.user)?(localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userId",l.user.id)):(localStorage.removeItem("isLoggedIn"),localStorage.removeItem("userId")))});t=s}catch(t){console.warn("认证初始化异常:",t),e&&i(e=>({...e,loading:!1}))}})(),()=>{if(e=!1,t)try{t.subscription.unsubscribe()}catch(e){console.warn("取消认证监听器失败:",e)}}},[c]);let m={...l,refreshAuth:d,logout:u,signOut:u};return(0,r.jsx)(s.Provider,{value:m,children:t})}function o(){let e=(0,n.useContext)(s);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function c(){let{authUser:e,loading:t}=o();return!t&&!!e}},1294:(e,t,l)=>{"use strict";l.d(t,{A:()=>n});var r=l(5155);function n(e){let{label:t,description:l,error:n,className:a="",wrapperClassName:s="",...i}=e;return(0,r.jsxs)("label",{className:("inline-flex items-center gap-2 cursor-pointer select-none "+(s||"")).trim(),children:[(0,r.jsx)("input",{type:"checkbox",...i,className:("peer sr-only "+(a||"")).trim()}),(0,r.jsx)("span",{"aria-hidden":"true",className:"relative inline-flex h-4 w-4 items-center justify-center rounded border border-gray-300 bg-white transition-colors duration-150 ease-out peer-focus-visible:outline-none peer-focus-visible:ring-2 peer-focus-visible:ring-[#2ECC71] peer-focus-visible:ring-offset-0 peer-checked:bg-[#2ECC71] peer-checked:border-[#2ECC71] peer-checked:[&>svg]:opacity-100",children:(0,r.jsx)("svg",{viewBox:"0 0 16 16",className:"h-3 w-3 text-white opacity-0 transition-opacity duration-150",fill:"none",stroke:"currentColor",strokeWidth:2.5,strokeLinecap:"round",strokeLinejoin:"round",children:(0,r.jsx)("path",{d:"M4 8l2.5 2.5L12 5"})})}),(t||l||n)&&(0,r.jsxs)("span",{className:"text-sm text-[#2c3e50] leading-5",children:[t&&(0,r.jsx)("span",{children:t}),l&&(0,r.jsx)("div",{className:"text-xs text-gray-500",children:l}),n&&(0,r.jsx)("div",{className:"text-xs text-red-500",children:n})]})]})}l(2115)},1659:(e,t,l)=>{"use strict";l.d(t,{A:()=>a});var r=l(5155),n=l(2115);function a(e){var t;let{label:l,description:a,error:s,className:i="",id:o,autoResize:c=!0,...d}=e,u=(0,n.useRef)(null),m=d.value;(0,n.useEffect)(()=>{if(!c||!u.current)return;let e=u.current,t=()=>{let t=document.activeElement===e,l=t?e.selectionStart:null,r=t?e.selectionEnd:null;if(e.style.height="auto",e.style.height="".concat(e.scrollHeight,"px"),e.style.overflowY="hidden",t&&"number"==typeof l&&"number"==typeof r)try{e.setSelectionRange(l,r)}catch(e){}};t();let l=()=>t();e.addEventListener("input",l);let r=new ResizeObserver(t);return r.observe(e),()=>{e.removeEventListener("input",l),r.disconnect()}},[c,m]);let h=null!=(t=d.rows)?t:2;return(0,r.jsxs)("div",{className:"w-full",children:[l&&(0,r.jsx)("label",{htmlFor:o,className:"block text-sm font-medium text-[#2c3e50]",children:l}),(0,r.jsx)("textarea",{id:o,ref:u,...d,rows:h,className:"".concat(l?"mt-2 ":"","w-full rounded-md border ").concat(s?"border-red-400":"border-gray-300"," bg-white p-3 text-[14px] leading-6 focus:border-[#2ECC71] focus:outline-none resize-none overflow-hidden ")+(i||"")}),a&&(0,r.jsx)("div",{className:"mt-1 text-xs text-gray-500",children:a}),s&&(0,r.jsx)("div",{className:"mt-1 text-xs text-red-500",children:s})]})}},2099:(e,t,l)=>{"use strict";l.d(t,{$:()=>i});var r=l(2354);let n="https://bkvbvmgcqfnxokklsxus.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdmJ2bWdjcWZueG9ra2xzeHVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3OTExNjIsImV4cCI6MjA3MDM2NzE2Mn0.uNkB5g0owHKEumiPDzek1K0ZaSDdIJhPT6FwHh0hmJ0",s=n&&a?(0,r.UU)(n,a):null;function i(){if(!n||!a)throw Error("缺少 Supabase 前端环境变量，请配置以下任一组合：\n1) NEXT_PUBLIC_SUPABASE_URL 和 NEXT_PUBLIC_SUPABASE_ANON_KEY\n或\n2) VITE_SUPABASE_URL 和 VITE_SUPABASE_ANON_KEY");if(!s)throw Error("Supabase 客户端未初始化，请刷新页面或检查环境变量");return s}},2379:(e,t,l)=>{"use strict";l.d(t,{A:()=>s});var r=l(5155),n=l(6874),a=l.n(n);function s(e){let{paths:t}=e;return(0,r.jsx)("nav",{className:"mb-6","aria-label":"面包屑导航",children:(0,r.jsx)("ol",{className:"flex items-center space-x-2 text-sm text-gray-500",children:t.map((e,t)=>(0,r.jsxs)("li",{className:"flex items-center",children:[t>0&&(0,r.jsx)("span",{className:"mx-2 text-gray-400","aria-hidden":"true",children:"/"}),e.href?(0,r.jsx)(a(),{href:e.href,className:"hover:text-[#2ECC71] hover:underline transition-colors",children:e.label}):(0,r.jsx)("span",{className:"text-gray-700 font-medium","aria-current":"page",children:e.label})]},t))})})}},2731:(e,t,l)=>{"use strict";l.d(t,{A:()=>n});var r=l(5155);function n(e){let{size:t="md",className:l=""}=e;return(0,r.jsx)("div",{className:"inline-block animate-spin rounded-full border-gray-200 border-t-emerald-500 ".concat({sm:"h-8 w-8 border-2",md:"h-14 w-14 border-3",lg:"h-24 w-24 border-4"}[t]," ").concat(l)})}},5695:(e,t,l)=>{"use strict";var r=l(8999);l.o(r,"useParams")&&l.d(t,{useParams:function(){return r.useParams}}),l.o(r,"usePathname")&&l.d(t,{usePathname:function(){return r.usePathname}}),l.o(r,"useRouter")&&l.d(t,{useRouter:function(){return r.useRouter}}),l.o(r,"useSearchParams")&&l.d(t,{useSearchParams:function(){return r.useSearchParams}})},5705:(e,t,l)=>{"use strict";l.r(t),l.d(t,{default:()=>I,runtime:()=>C});var r=l(5155),n=l(2115),a=l(6874),s=l.n(a),i=l(6766),o=l(1659),c=l(2099),d=l(8204);function u(e){let{name:t,src:l}=e;if(l)return(0,r.jsx)(i.default,{src:l,alt:t,width:28,height:28,className:"h-7 w-7 rounded-full object-cover",unoptimized:!0});let n=t.trim().split(/\s+/).slice(0,2).map(e=>{var t;return null!=(t=e[0])?t:""}).join("").toUpperCase();return(0,r.jsx)("div",{className:"grid h-7 w-7 place-items-center rounded-full bg-[#ecf0f1] text-[#2c3e50] text-[12px] font-semibold",children:n})}function m(e){var t,l,a,s,i,c,d,h,x,p;let{node:f,depth:g=0,likesMap:v,replyOpen:b,replyValue:y,toggleLike:w,setReplyOpen:j,setReplyValue:N,submitComment:k,formatTime:S,currentUserId:C,onRequestDelete:E}=e,I=null!=(i=null==(t=f.profiles)?void 0:t.nickname)?i:"匿名用户",_=null!=(c=null==(l=f.profiles)?void 0:l.avatar_url)?c:void 0,A=null!=(d=null==(a=v[f.id])?void 0:a.liked)&&d,T=null!=(h=null==(s=v[f.id])?void 0:s.likes)?h:0,P=null!=(x=b[f.id])&&x;return(0,n.useEffect)(()=>{if(!P)return;let e="reply-".concat(f.id),t=requestAnimationFrame(()=>{let t=document.getElementById(e);if(t){t.focus();try{let e=t.value.length;t.setSelectionRange(e,e)}catch(e){}}});return()=>cancelAnimationFrame(t)},[P,f.id]),(0,r.jsxs)("li",{className:"flex gap-3",children:[(0,r.jsx)(u,{name:I,src:_}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-[14px] font-medium text-[#2c3e50]",children:I}),(0,r.jsx)("span",{className:"text-[12px] text-[#95a5a6]",children:S(f.created_at)})]}),(0,r.jsx)("p",{className:"mt-1 text-[14px] leading-6 text-gray-700",children:f.content}),(0,r.jsxs)("div",{className:"mt-2 flex items-center gap-4",children:[(0,r.jsxs)("button",{onClick:()=>w(f.id),className:"inline-flex items-center gap-1 text-[13px] ".concat(A?"text-[#e74c3c]":"text-gray-600 hover:text-[#e74c3c]"),"aria-label":"点赞评论",children:[(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:A?"currentColor":"none",stroke:"currentColor",strokeWidth:"2",className:"h-4 w-4",children:(0,r.jsx)("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"})}),(0,r.jsx)("span",{children:T})]}),(0,r.jsx)("button",{onClick:()=>j(e=>({...e,[f.id]:!e[f.id]})),className:"text-[13px] text-[#3498db] hover:underline",children:"回复"}),C&&C===f.author_id?(0,r.jsx)("button",{onClick:()=>E(f.id),className:"text-[13px] text-gray-500 hover:underline",children:"删除"}):null]}),b[f.id]&&(0,r.jsxs)("div",{className:"mt-3 flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-3 md:p-4",children:[(0,r.jsx)(o.A,{id:"reply-".concat(f.id),value:null!=(p=y[f.id])?p:"",onChange:e=>N(t=>({...t,[f.id]:e.target.value})),placeholder:"回复 ".concat(I," ..."),rows:1,autoResize:!0,className:"border-0 focus:border-transparent focus:ring-0 bg-white"}),(0,r.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,r.jsx)("button",{onClick:()=>j(e=>({...e,[f.id]:!1})),className:"rounded-lg border border-gray-300 px-3 py-2 text-gray-700 hover:bg-gray-50",children:"取消"}),(0,r.jsx)("button",{onClick:async()=>{var e;let t=(null!=(e=y[f.id])?e:"").trim();t&&(await k(t,f.id),N(e=>({...e,[f.id]:""})),j(e=>({...e,[f.id]:!1})))},className:"rounded-lg bg-[#2ECC71] px-4 py-2 text-white hover:bg-[#27AE60]",children:"发表回复"})]})]}),f.replies.length>0&&(0,r.jsx)("ul",{className:"mt-4 space-y-4 pl-0 border-l border-gray-200",children:f.replies.map(e=>(0,r.jsx)(m,{node:e,depth:g+1,likesMap:v,replyOpen:b,replyValue:y,toggleLike:w,setReplyOpen:j,setReplyValue:N,submitComment:k,formatTime:S,currentUserId:C,onRequestDelete:E},e.id))})]})]},f.id)}function h(e){let{ideaId:t,initialComments:l}=e,[a,s]=(0,n.useState)(""),[i,u]=(0,n.useState)({}),[h,x]=(0,n.useState)({}),[p,f]=(0,n.useState)({}),[g,v]=(0,n.useState)(null),[b,y]=(0,n.useState)(null),[w,j]=(0,n.useState)(!1);(0,n.useEffect)(()=>{(0,c.$)().auth.getSession().then(e=>{var t,l,r,n;v(null!=(n=null==(r=e.data)||null==(l=r.session)||null==(t=l.user)?void 0:t.id)?n:null)}).catch(()=>v(null))},[]);let[N,k]=(0,n.useState)([]),[S,C]=(0,n.useState)(!1),[E,I]=(0,n.useState)(!1),[_,A]=(0,n.useState)(null),[T,P]=(0,n.useState)({limit:20,offset:0,total:0,hasMore:!1}),L=(0,n.useCallback)(async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],l=Date.now();try{var r,n,a,s,i;t?I(!0):(C(!0),A(null));let o=(0,c.$)(),d=null!=(a=null==(n=(await o.auth.getSession()).data)||null==(r=n.session)?void 0:r.access_token)?a:"",m={};d&&(m.Authorization="Bearer ".concat(d));let h=t?T.offset+T.limit:0,x="/api/comments?creative_id=".concat(encodeURIComponent(e),"&limit=").concat(T.limit,"&offset=").concat(h),p=await fetch(x,{headers:m,cache:"default"}),f=Date.now();if(!p.ok){let e=await p.text();throw Error(e||"加载失败（".concat(p.status,"）"))}let g=await p.json(),v=Date.now(),b=null!=(s=g.comments)?s:[],y=null!=(i=g.pagination)?i:{limit:20,offset:0,total:0,hasMore:!1};t?k(e=>[...e,...b]):k(b),P(y),u(e=>{let t={...e};for(let e of b){var l;let r=!!e.current_user_liked,n=Number(null!=(l=e.likes_count)?l:0);t[e.id]={liked:r,likes:Math.max(0,n)}}return t});let w=Date.now();console.log("[评论前端性能] 总耗时: ".concat(w-l,"ms, API调用: ").concat(f-l,"ms, 数据处理: ").concat(w-v,"ms, 评论数: ").concat(b.length)),g.performance&&console.log("[评论后端性能]",g.performance)}catch(t){let e=Date.now();A(t instanceof Error?t.message:"加载异常"),console.error("获取评论异常 (耗时".concat(e-l,"ms):"),t)}finally{C(!1),I(!1)}},[T.limit,T.offset]),R=n.useRef(!1);(0,n.useEffect)(()=>{if(l&&Array.isArray(l)){k(l);let e={};l.forEach(t=>{var l;e[t.id]={liked:!!t.current_user_liked,likes:null!=(l=t.likes_count)?l:0}}),u(e);return}t&&!R.current&&(R.current=!0,L(t))},[t,L,l]),(0,n.useEffect)(()=>{let e="injectComment:".concat(null!=t?t:"");function l(){if(!t)return;let l=localStorage.getItem(e);l&&(s(l),localStorage.removeItem(e),localStorage.setItem("pendingToast","已将您的描述填入评论框，确认后再发布"))}l();let r=t=>{t.key===e&&t.newValue&&l()},n=()=>l();return window.addEventListener("storage",r),window.addEventListener("focus",n),()=>{window.removeEventListener("storage",r),window.removeEventListener("focus",n)}},[t]);let U=(0,n.useMemo)(()=>{let e=Date.now();if(0===N.length)return[];let t=new Map,l=[],r=[];for(let e of N){let n={...e,replies:[]},a=i[n.id];if(a&&(n.likes=a.likes,n.liked=a.liked),t.set(n.id,n),n.parent_comment_id){let e=t.get(n.parent_comment_id);e?e.replies.push(n):r.push(n)}else l.push(n)}for(let e of r)if(e.parent_comment_id){let r=t.get(e.parent_comment_id);r?r.replies.push(e):l.push(e)}let n=(e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime();!function e(t){for(let l of(t.sort(n),t))e(l.replies)}(l);let a=Date.now()-e;return a>10&&console.log("[评论树结构计算] 优化后耗时: ".concat(a,"ms, 评论数: ").concat(N.length,", 根节点数: ").concat(l.length,", 孤儿节点: ").concat(r.length)),l},[N,i]);function z(e){try{return new Date(e).toLocaleString()}catch(t){return e}}function M(e){var t;let l=null!=(t=i[e])?t:{liked:!1,likes:0},r=!l.liked,n=Math.max(0,l.likes+(r?1:-1));u(t=>({...t,[e]:{liked:r,likes:n}})),(async()=>{try{var t,a,s;let l=(0,c.$)(),i=null!=(s=null==(a=(await l.auth.getSession()).data)||null==(t=a.session)?void 0:t.access_token)?s:"";if(!i)throw Error("请先登录");let o=await fetch("/api/comments/".concat(encodeURIComponent(e),"/like"),{method:r?"POST":"DELETE",headers:{Authorization:"Bearer ".concat(i)}}),d=await o.json().catch(()=>null);if(!o.ok)throw Error((null==d?void 0:d.error)||(null==d?void 0:d.message)||"请求失败（".concat(o.status,"）"));let m="number"==typeof(null==d?void 0:d.likes_count)?Number(null==d?void 0:d.likes_count):n;u(t=>({...t,[e]:{liked:r,likes:Math.max(0,m)}}))}catch(t){u(t=>({...t,[e]:{liked:l.liked,likes:l.likes}})),alert(t instanceof Error?t.message:"操作失败")}})()}async function D(e){let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!t)return;let r=e.trim();if(r)try{var n,a,s,i;let e=(0,c.$)(),o=null!=(s=null==(a=(await e.auth.getSession()).data)||null==(n=a.session)?void 0:n.access_token)?s:"";if(!o)return void alert("请先登录后再发表评论");let d=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({content:r,creative_id:t,parent_comment_id:l})}),m=await d.json().catch(()=>null);if(401===d.status)return void alert("登录已过期，请重新登录");if(!d.ok)throw Error((null==m?void 0:m.error)||(null==m?void 0:m.message)||"请求失败（".concat(d.status,"）"));let h=null!=(i=null==m?void 0:m.comment)?i:null;h&&(k(e=>[...e,h]),u(e=>{var t;return{...e,[h.id]:null!=(t=e[h.id])?t:{liked:!1,likes:0}}}))}catch(e){alert(e instanceof Error?e.message:"发表失败")}}async function O(e){try{var t,l,r;let n=(0,c.$)(),a=null!=(r=null==(l=(await n.auth.getSession()).data)||null==(t=l.session)?void 0:t.access_token)?r:"";if(!a)return alert("请先登录"),!1;let s=await fetch("/api/comments?id=".concat(encodeURIComponent(e)),{method:"DELETE",headers:{Authorization:"Bearer ".concat(a)}}),i=await s.json().catch(()=>null);if(401===s.status)return alert("登录已过期，请重新登录"),!1;if(!s.ok)throw Error((null==i?void 0:i.error)||(null==i?void 0:i.message)||"请求失败（".concat(s.status,"）"));return k(t=>t.filter(t=>t.id!==e)),u(t=>{let{[e]:l,...r}=t;return r}),x(t=>{let{[e]:l,...r}=t;return r}),f(t=>{let{[e]:l,...r}=t;return r}),k(t=>((e,t)=>{let l=new Set,r=e=>{l.add(e),t.forEach(t=>{t.parent_comment_id===e&&r(t.id)})};return r(e),t.filter(e=>!l.has(e.id))})(e,t)),u(t=>{let l={...t};return delete l[e],l}),!0}catch(e){return alert(e instanceof Error?e.message:"删除失败"),!1}}let B=N.length;return(0,r.jsxs)("div",{className:"mt-3",children:[(0,r.jsx)("div",{className:"flex items-baseline justify-between",children:(0,r.jsxs)("h3",{className:"text-lg font-semibold text-[#2c3e50]",children:["评论（",B>99?"99+":B,"）"]})}),(0,r.jsxs)("div",{className:"mt-3 flex flex-col gap-3 rounded-lg border border-gray-200 bg-white p-3 md:p-4",children:[(0,r.jsx)(o.A,{value:a,onChange:e=>s(e.target.value),placeholder:"写下你的看法...",rows:1,autoResize:!0,className:"border-0 focus:border-transparent focus:ring-0 bg-white"}),(0,r.jsx)("div",{className:"flex justify-end",children:(0,r.jsx)("button",{onClick:async()=>{let e=a.trim();e&&(await D(e,null),s(""))},className:"rounded-lg bg-[#2ECC71] px-4 py-2 text-white hover:bg-[#27AE60]",children:"发表评论"})})]}),S?(0,r.jsx)("div",{className:"mt-5 text-sm text-gray-500",children:"加载中..."}):_?(0,r.jsx)("div",{className:"mt-5 text-sm text-red-600",children:_}):0===U.length?(0,r.jsx)("div",{className:"mt-5 text-sm text-gray-500",children:"还没有评论，快来抢沙发～"}):(0,r.jsx)("ul",{className:"mt-5 space-y-4",children:U.map(e=>(0,r.jsx)(m,{node:e,likesMap:i,replyOpen:h,replyValue:p,toggleLike:M,setReplyOpen:x,setReplyValue:f,submitComment:D,formatTime:z,currentUserId:g,onRequestDelete:y},e.id))}),T.hasMore&&(0,r.jsx)("div",{className:"mt-6 text-center",children:(0,r.jsx)("button",{onClick:()=>{t&&T.hasMore&&!E&&L(t,!0)},disabled:E,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:E?"加载中...":"加载更多评论"})}),(0,r.jsxs)(d.A,{isOpen:!!b,onClose:()=>{w||y(null)},children:[(0,r.jsx)("p",{className:"text-[16px] sm:text-[18px] leading-7 text-gray-800",children:"确定删除此评论？"}),(0,r.jsxs)("div",{className:"mt-6 flex items-center justify-end gap-3",children:[(0,r.jsx)("button",{type:"button",onClick:()=>y(null),disabled:w,className:"rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-[#2c3e50] hover:bg-gray-50",children:"取消"}),(0,r.jsx)("button",{type:"button",onClick:async()=>{if(!b)return;y(null),j(!0);let e=await O(b);j(!1),e&&(localStorage.setItem("pendingToast","删除成功"),window.dispatchEvent(new Event("localToast")))},className:"rounded-md bg-red-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-red-700 disabled:opacity-50",disabled:w,children:"确认"})]})]})]})}var x=l(5695),p=l(283);async function f(e,t){let{timeoutMs:l=1e4,signal:r,...n}=t||{},a=new AbortController,s=setTimeout(()=>a.abort("timeout"),l);if(r){var i;r.aborted?a.abort(null!=(i=r.reason)?i:"external-signal"):r.addEventListener("abort",()=>{var e;return a.abort(null!=(e=r.reason)?e:"external-signal")},{once:!0})}try{return await fetch(e,{...n,signal:a.signal})}finally{clearTimeout(s)}}function g(e){let t="__mini_toast__",l=document.getElementById(t);l||((l=document.createElement("div")).id=t,l.style.position="fixed",l.style.top="20px",l.style.left="50%",l.style.transform="translateX(-50%)",l.style.zIndex="9999",l.style.padding="10px 14px",l.style.borderRadius="8px",l.style.background="rgba(0,0,0,0.8)",l.style.color="#fff",l.style.fontSize="14px",l.style.boxShadow="0 4px 10px rgba(0,0,0,0.2)",document.body.appendChild(l)),l.textContent=e,l.style.opacity="1",setTimeout(()=>{l&&(l.style.transition="opacity .3s ease",l.style.opacity="0")},1800)}function v(e){let{supporters:t,platforms:l,bounty:a,ideaId:i,initialUpvoteData:o}=e,c=(0,x.usePathname)(),{token:d,userId:u}=(0,p.As)(),[m,h]=(0,n.useState)(!1),[v,b]=(0,n.useState)(t),y=(0,n.useRef)(!1),w=(0,n.useRef)(null),j=(0,n.useRef)(!1);async function N(){if(!i)return;let e=!y.current;try{if(!d){g("请先登录"),window.location.assign("/login");return}if(j.current=!0,h(e),b(t=>e?t+1:Math.max(0,t-1)),y.current=e,w.current)try{w.current.abort("superseded")}catch(e){}let t=new AbortController;w.current=t;let l=await f("/api/creatives/".concat(i,"/upvote"),{method:e?"POST":"DELETE",headers:{Authorization:"Bearer ".concat(d)},timeoutMs:1e4,signal:t.signal});if(w.current!==t)return;if(!l.ok){if(y.current===e){h(!e),b(t=>e?Math.max(0,t-1):t+1),g(e?"点赞失败，请重试":"取消失败，请重试");let t=await l.text().catch(()=>"");console.warn("Upvote toggle failed:",t)}return}let r=await l.json().catch(()=>null);if(w.current!==t)return;if(r&&!1===r.changed?console.warn("Upvote API returned changed=false, keep optimistic count.",r):(null==r?void 0:r.upvote_count)!=null&&b(r.upvote_count),u){let t="supported:".concat(u,":").concat(i);e?localStorage.setItem(t,"1"):localStorage.removeItem(t)}}catch(t){if(t instanceof DOMException&&"AbortError"===t.name)return;y.current===e&&(h(!e),b(t=>e?Math.max(0,t-1):t+1),console.error(t),g("操作失败，请稍后重试"))}}return(0,n.useEffect)(()=>{if(!i)return;if(o){if(b(o.upvote_count),h(o.supported),y.current=o.supported,u){let e="supported:".concat(u,":").concat(i);o.supported?localStorage.setItem(e,"1"):localStorage.removeItem(e)}return}let e=!1;return async function(){try{var l;if(u){let e="supported:".concat(u,":").concat(i);"1"===localStorage.getItem(e)&&(h(!0),y.current=!0,b(e=>e<=0?1:e))}let r=await fetch("/api/creatives/".concat(i,"/upvote"),{method:"GET",headers:d?{Authorization:"Bearer ".concat(d)}:void 0}),n=await r.json().catch(()=>null);if(!r.ok)return void console.warn("Init upvote fetch failed:",n);if(e||j.current)return;let a=null!=(l=null==n?void 0:n.upvote_count)?l:t,s=!!(null==n?void 0:n.supported);if(b(Number(a)||0),h(s),y.current=s,u){let e="supported:".concat(u,":").concat(i);s?localStorage.setItem(e,"1"):localStorage.removeItem(e)}}catch(e){console.warn("Init upvote error:",e)}}(),()=>{e=!0}},[i,t,c,o,d,u]),(0,n.useEffect)(()=>{if(!i)return;let e="pendingSupport:".concat(i);localStorage.getItem(e)&&(localStorage.removeItem(e),h(!0),b(e=>e+1),y.current=!0)},[i]),(0,r.jsxs)("div",{className:"sticky top-24 space-y-4",children:[(0,r.jsxs)("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:[(0,r.jsx)("button",{onClick:N,className:"w-full rounded-xl px-5 py-3 text-[16px] font-semibold text-white ".concat(m?"bg-gray-400 hover:bg-gray-400":"bg-[#2ECC71] hover:bg-[#27AE60]"),children:m?"✓ 已想要":"我也要"}),(0,r.jsxs)("p",{className:"mt-2 text-center text-[13px] text-gray-600",children:["已有 ",Intl.NumberFormat("zh-CN").format(v)," 人想要"]})]}),(0,r.jsx)("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:(0,r.jsx)(s(),{href:"/projects/new?idea_id=".concat(null!=i?i:""),className:"block w-full rounded-xl border border-[#2ECC71] px-5 py-3 text-center text-[16px] font-semibold text-[#2ECC71] hover:bg-[#2ECC71]/10",children:"我来解决"})}),(0,r.jsx)("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm",children:(0,r.jsx)("ul",{className:"space-y-3 text-[14px] text-[#2c3e50]",children:(null==l?void 0:l.length)?(0,r.jsxs)("li",{children:[(0,r.jsx)("span",{className:"font-medium",children:"期望终端："}),(0,r.jsx)("span",{className:"text-gray-600",children:l.join("、")})]}):null})})]})}function b(e){let{ideaId:t}=e;return(0,n.useEffect)(()=>{let e=localStorage.getItem("pendingToast");e&&localStorage.setItem("pendingToast",e);let l="pendingComment:".concat(t),r=localStorage.getItem(l);r&&(localStorage.setItem("injectComment:".concat(t),r),localStorage.removeItem(l))},[t]),null}var y=l(2379),w=l(2731),j=l(7428),N=l(1294);let k=[{id:"web",label:"网页"},{id:"mini",label:"小程序"},{id:"ios",label:"iOS"},{id:"android",label:"安卓"},{id:"win",label:"Windows"},{id:"mac",label:"Mac"}];function S(e){let{id:t,initialTitle:l,initialDescription:a,authorId:s,initialTerminals:i}=e,u=(0,x.useRouter)(),[m,h]=(0,n.useState)(!1),[p,f]=(0,n.useState)(l),[g,v]=(0,n.useState)(a),[b,y]=(0,n.useState)({web:!1,mini:!1,ios:!1,android:!1,win:!1,mac:!1}),[w,S]=(0,n.useState)(!1),[C,E]=(0,n.useState)(null),[I,_]=(0,n.useState)(!1),[A,T]=(0,n.useState)(null);(0,n.useEffect)(()=>{let e;return(async()=>{try{var t,l;let r=(0,c.$)(),[{data:n},{data:a}]=await Promise.all([r.auth.getUser(),r.auth.getSession()]);_(!!n.user&&n.user.id===s),T(null!=(l=null==(t=a.session)?void 0:t.access_token)?l:null);let{data:i}=r.auth.onAuthStateChange((e,t)=>{var l,r;_((null==t||null==(l=t.user)?void 0:l.id)===s),T(null!=(r=null==t?void 0:t.access_token)?r:null)});e=()=>{try{i.subscription.unsubscribe()}catch(e){}}}catch(e){_(!1),T(null)}})(),()=>{e&&e()}},[s]);let P=(0,n.useMemo)(()=>!w&&p.trim().length>0&&g.trim().length>0,[w,p,g]),L=()=>{w||h(!1)},R=async()=>{if(P){if(!A)return void E("当前未登录或会话已过期，请先登录");try{S(!0),E(null);let e=Object.keys(b).filter(e=>b[e]),l=await fetch("/api/creatives/".concat(encodeURIComponent(t)),{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(A)},body:JSON.stringify({title:p.trim(),description:g.trim(),terminals:e})}),r=await l.json().catch(()=>({}));if(!l.ok)return void E((null==r?void 0:r.message)||(null==r?void 0:r.error)||"保存失败，请稍后重试");h(!1),u.refresh()}catch(e){E("网络错误，请稍后重试")}finally{S(!1)}}};return I?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{type:"button",onClick:()=>{f(l),v(a);let e=new Set((null!=i?i:[]).map(e=>String(e)));y({web:e.has("web"),mini:e.has("mini"),ios:e.has("ios"),android:e.has("android"),win:e.has("win"),mac:e.has("mac")}),E(null),h(!0)},className:"ml-auto inline-flex items-center rounded-lg border border-emerald-500 px-3 py-1.5 text-sm font-medium text-emerald-600 hover:bg-emerald-50",children:"编辑"}),(0,r.jsx)(d.A,{isOpen:m,onClose:L,title:"编辑创意",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)(j.A,{id:"edit-title",label:"标题",placeholder:"请输入创意标题",value:p,onChange:e=>f(e.currentTarget.value),maxLength:120,required:!0}),(0,r.jsx)(o.A,{id:"edit-description",label:"详细描述",placeholder:"请输入创意详情",value:g,onChange:e=>v(e.currentTarget.value),rows:6,autoResize:!0,required:!0}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"block text-sm font-medium text-[#2c3e50]",children:"期望终端"}),(0,r.jsx)("div",{className:"mt-3 flex flex-wrap gap-3",children:k.map(e=>(0,r.jsx)(N.A,{id:"edit-".concat(e.id),label:e.label,wrapperClassName:"inline-flex cursor-pointer items-center gap-2 rounded-full border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-50",checked:!!b[e.id],onChange:t=>y(l=>({...l,[e.id]:t.target.checked}))},e.id))})]}),C?(0,r.jsx)("div",{className:"text-sm text-red-600",children:C}):null,(0,r.jsxs)("div",{className:"flex justify-end gap-3 pt-2",children:[(0,r.jsx)("button",{type:"button",onClick:L,className:"rounded-lg border border-gray-300 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50",disabled:w,children:"取消"}),(0,r.jsx)("button",{type:"button",onClick:R,className:"rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:brightness-110 disabled:cursor-not-allowed disabled:opacity-60",disabled:!P,children:w?"保存中...":"保存"})]})]})})]}):null}let C="edge";function E(e){let{name:t,src:l}=e;if(l)return(0,r.jsx)(i.default,{src:l,alt:t,width:40,height:40,className:"h-10 w-10 rounded-full object-cover",unoptimized:!0});let n=t.trim().split(/\s+/).slice(0,2).map(e=>{var t;return null!=(t=e[0])?t:""}).join("").toUpperCase();return(0,r.jsx)("div",{className:"grid h-10 w-10 place-items-center rounded-full bg-[#ecf0f1] text-[#2c3e50] text-sm font-semibold",children:n})}function I(){var e,t,l,a,i;let o=(0,x.useParams)().id,[c,d]=(0,n.useState)(null),[u,m]=(0,n.useState)(!0),[p,f]=(0,n.useState)(null);if((0,n.useEffect)(()=>{let e=async()=>{try{m(!0),f(null);let t=await fetch("/api/creatives/".concat(encodeURIComponent(o)));if(t.ok){var e;let l=await t.json();d(null!=(e=null==l?void 0:l.creative)?e:null)}else{let e=await t.json();f((null==e?void 0:e.message)||"获取创意详情失败")}}catch(e){f("网络连接错误，请稍后重试")}finally{m(!1)}};o&&e()},[o]),(0,n.useEffect)(()=>{c&&(document.title="创意详情 - #".concat(o))},[c,o]),u)return(0,r.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50",children:(0,r.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,r.jsx)("div",{className:"text-center py-16",children:(0,r.jsx)(w.A,{})})})});if(p||!c)return(0,r.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-blue-50",children:(0,r.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,r.jsxs)("div",{className:"text-center py-16",children:[(0,r.jsx)("div",{className:"text-6xl mb-4",children:"\uD83E\uDD14"}),(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-800 mb-2",children:p||"创意不存在"}),(0,r.jsx)("p",{className:"text-gray-600 mb-6",children:p?"请稍后重试":"这个创意可能已被删除或不存在"}),(0,r.jsx)(s(),{href:"/creatives",className:"inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"返回创意广场"})]})})});let g=(null==c?void 0:c.description)?String(c.description).split(/\n{2,}|\r?\n/).map(e=>e.trim()).filter(Boolean):["这是一个用于说明的创意详情占位文本。","系统会定时抓取数据并生成指标曲线，用户可以为自己关注的主题设置预警阈值。","后续将开放更多功能，欢迎留言讨论。"],j={id:c.id,title:c.title,author:{name:null!=(l=null==c||null==(e=c.profiles)?void 0:e.nickname)?l:"匿名用户",time:new Date(c.created_at).toLocaleDateString("zh-CN"),avatarUrl:(null==c||null==(t=c.profiles)?void 0:t.avatar_url)||void 0},description:g,platforms:Array.isArray(c.terminals)?c.terminals:[c.terminals].filter(Boolean),bounty:c.bounty_amount||500,supporters:Number(null!=(a=c.upvote_count)?a:0)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(y.A,{paths:[{href:"/creatives",label:"创意广场"},{label:"创意详情"}]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-3",children:[(0,r.jsxs)("section",{className:"md:col-span-2",children:[(0,r.jsx)("div",{className:"flex items-start justify-between gap-3",children:(0,r.jsx)("h1",{className:"text-3xl font-extrabold leading-9 text-[#2c3e50]",children:j.title})}),(0,r.jsxs)("div",{className:"mt-3 flex items-center gap-3",children:[(0,r.jsx)(E,{name:j.author.name,src:j.author.avatarUrl}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-[14px] font-medium text-[#2c3e50]",children:j.author.name}),(0,r.jsx)("p",{className:"text-[12px] text-[#95a5a6]",children:j.author.time})]})]}),(0,r.jsxs)("div",{className:"mt-6 flex items-center justify-between",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold text-[#2c3e50]",children:"创意描述"}),(null==c?void 0:c.author_id)?(0,r.jsx)(S,{id:String(c.id),initialTitle:c.title,initialDescription:null!=(i=c.description)?i:"",authorId:c.author_id,initialTerminals:Array.isArray(c.terminals)?c.terminals:[c.terminals].filter(Boolean)}):null]}),(0,r.jsx)("div",{className:"mt-3 rounded-lg border border-gray-200 bg-white p-3 md:p-4",children:j.description.map((e,t)=>(0,r.jsx)("p",{className:"text-[15px] leading-7 text-gray-700 mb-4 last:mb-0",children:e},t))})]}),(0,r.jsx)("aside",{className:"md:col-span-1",children:(0,r.jsx)(v,{supporters:j.supporters,platforms:j.platforms,bounty:j.bounty,ideaId:String(j.id),initialUpvoteData:null})}),(0,r.jsx)("section",{className:"md:col-span-2",children:(0,r.jsx)(h,{ideaId:String(c.id),initialComments:void 0})})]}),(0,r.jsx)(b,{ideaId:String(j.id)})]})}},7428:(e,t,l)=>{"use strict";l.d(t,{A:()=>n});var r=l(5155);function n(e){let{label:t,description:l,error:n,className:a="",id:s,...i}=e;return(0,r.jsxs)("div",{className:"w-full",children:[t&&(0,r.jsx)("label",{htmlFor:s,className:"block text-sm font-medium text-[#2c3e50]",children:t}),(0,r.jsx)("input",{id:s,type:"text",...i,className:"mt-2 w-full rounded-md border ".concat(n?"border-red-400":"border-gray-300"," bg-white p-3 text-[14px] focus:border-1 focus:border-[#2ECC71] focus:outline-none ")+(a||"")}),l&&(0,r.jsx)("div",{className:"mt-1 text-xs text-gray-500",children:l}),n&&(0,r.jsx)("div",{className:"mt-1 text-xs text-red-500",children:n})]})}l(2115)},7907:(e,t,l)=>{Promise.resolve().then(l.bind(l,5705))},8204:(e,t,l)=>{"use strict";l.d(t,{A:()=>s});var r=l(5155),n=l(2115);function a(e){let{onClick:t,ariaLabel:l="关闭",className:n="",size:a="md"}=e;return(0,r.jsx)("button",{type:"button","aria-label":l,onClick:t,className:"inline-grid place-items-center rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-[#2ECC71] ".concat("sm"===a?"h-7 w-7":"h-8 w-8"," ").concat(n),title:l,children:(0,r.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"h-4 w-4",children:(0,r.jsx)("path",{d:"M18 6 6 18M6 6l12 12"})})})}function s(e){let{isOpen:t,onClose:l,title:s,children:i}=e;return((0,n.useEffect)(()=>{function e(e){"Escape"===e.key&&l()}return t&&document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[t,l]),t)?(0,r.jsxs)("div",{className:"fixed inset-0 z-50",children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/50",onClick:l}),(0,r.jsx)("div",{className:"absolute inset-0 grid place-items-center p-4",children:(0,r.jsxs)("div",{className:"relative w-full max-w-lg rounded-2xl bg-white p-6 shadow-xl",role:"dialog","aria-modal":"true","aria-label":s||"模态弹窗",onClick:e=>e.stopPropagation(),children:[(0,r.jsxs)("div",{className:"flex items-start",children:[s?(0,r.jsx)("h3",{className:"text-lg font-semibold text-[#2c3e50]",children:s}):null,(0,r.jsx)(a,{className:"ml-auto -mr-2 -mt-2",onClick:l})]}),(0,r.jsx)("div",{className:s?"mt-4":"",children:i})]})})]}):null}}},e=>{e.O(0,[874,354,766,441,964,358],()=>e(e.s=7907)),_N_E=e.O()}]);