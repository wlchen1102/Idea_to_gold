(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[834],{57:(e,t,l)=>{Promise.resolve().then(l.bind(l,1404))},1404:(e,t,l)=>{"use strict";l.r(t),l.d(t,{default:()=>i});var a=l(5155),r=l(2115),s=l(2099),n=l(6766);let i=function(){let[e,t]=(0,r.useState)(null),[l,i]=(0,r.useState)(""),[o,d]=(0,r.useState)(""),[c,u]=(0,r.useState)(""),[m,f]=(0,r.useState)(!1),[h,x]=(0,r.useState)(!0),b=(0,r.useRef)(!1);(0,r.useEffect)(()=>{(async()=>{if(!b.current){b.current=!0,x(!0);try{let e=(0,s.$)(),{data:{session:l}}=await e.auth.getSession(),a=null==l?void 0:l.access_token;if(!a)return void x(!1);let r=await fetch("/api/users/me/profile",{headers:{Authorization:"Bearer ".concat(a)},cache:"no-store"});if(!r.ok){let e=await r.text();console.warn("加载用户资料失败: ".concat(e)),x(!1);return}let n=await r.json();n.profile?(t(n.profile),i(n.profile.nickname||""),d(n.profile.avatar_url||""),u(n.profile.bio||"")):console.warn("未找到用户资料")}catch(e){console.error("加载用户资料失败:",e)}finally{x(!1)}}})()},[]);let p=async()=>{f(!0);try{let t=(0,s.$)(),{data:{session:a}}=await t.auth.getSession();if(!(null==a?void 0:a.access_token)){localStorage.setItem("pendingToast","登录已过期，请重新登录"),window.dispatchEvent(new Event("localToast"));return}let r=await fetch("/api/users/me/profile",{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a.access_token)},body:JSON.stringify({nickname:l.trim()||null,bio:c.trim()||null})});if(r.ok)localStorage.setItem("pendingToast","保存成功！"),window.dispatchEvent(new Event("localToast")),window.dispatchEvent(new CustomEvent("auth:changed",{detail:{userId:null==e?void 0:e.id}}));else{let e=await r.text();localStorage.setItem("pendingToast","保存失败: ".concat(e)),window.dispatchEvent(new Event("localToast"))}}catch(e){console.error("保存失败:",e),localStorage.setItem("pendingToast","保存失败，请重试"),window.dispatchEvent(new Event("localToast"))}finally{f(!1)}},g=h||!e||m;return(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,a.jsx)("div",{className:"mx-auto max-w-2xl px-4 sm:px-6 lg:px-8",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-6",children:"账户设置"}),!e&&!h&&(0,a.jsxs)("div",{className:"mb-4 p-3 rounded-lg text-sm bg-yellow-50 text-yellow-800",children:["未登录状态下信息不可编辑，请先登录。",(0,a.jsx)("a",{href:"/login",className:"ml-3 underline text-emerald-700 hover:text-emerald-800",children:"去登录"})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("div",{children:(0,a.jsxs)("div",{className:"grid gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"头像"}),(0,a.jsx)("div",{className:"flex items-center gap-4",children:h?(0,a.jsx)("div",{className:"h-16 w-16 rounded-full bg-gray-200 animate-pulse"}):o?(0,a.jsx)(n.default,{src:o,alt:"用户头像",width:64,height:64,unoptimized:!0,className:"h-16 w-16 rounded-full object-cover border-2 border-gray-200",onError:e=>{e.currentTarget.style.display="none"}}):(0,a.jsx)("div",{className:"h-16 w-16 rounded-full bg-emerald-500 text-white flex items-center justify-center text-lg font-bold",children:(null==l?void 0:l.charAt(0))||"用"})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"用户ID"}),(0,a.jsx)("input",{type:"text",value:(null==e?void 0:e.id)||"",placeholder:h?"加载中...":e?e.id:"未登录",disabled:!0,className:"w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-gray-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"昵称"}),(0,a.jsx)("input",{type:"text",value:l,onChange:e=>i(e.target.value),placeholder:h?"加载中...":"请输入昵称",disabled:g,className:"w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-50 disabled:text-gray-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"个人简介"}),(0,a.jsx)("textarea",{value:c,onChange:e=>u(e.target.value),placeholder:h?"加载中...":"请输入个人简介",rows:4,disabled:g,className:"w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-50 disabled:text-gray-500"})]})]})}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)("button",{onClick:p,disabled:m||h||!e,className:"rounded-lg bg-emerald-600 px-6 py-2 text-white font-semibold hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed",children:m?"保存中...":h||!e?"等待数据...":"保存更改"})})]})]})})})}},2099:(e,t,l)=>{"use strict";l.d(t,{$:()=>i});var a=l(2354);let r="https://bkvbvmgcqfnxokklsxus.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrdmJ2bWdjcWZueG9ra2xzeHVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3OTExNjIsImV4cCI6MjA3MDM2NzE2Mn0.uNkB5g0owHKEumiPDzek1K0ZaSDdIJhPT6FwHh0hmJ0",n=r&&s?(0,a.UU)(r,s):null;function i(){if(!r||!s)throw Error("缺少 Supabase 前端环境变量，请配置以下任一组合：\n1) NEXT_PUBLIC_SUPABASE_URL 和 NEXT_PUBLIC_SUPABASE_ANON_KEY\n或\n2) VITE_SUPABASE_URL 和 VITE_SUPABASE_ANON_KEY");if(!n)throw Error("Supabase 客户端未初始化，请刷新页面或检查环境变量");return n}},6654:(e,t,l)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"useMergedRef",{enumerable:!0,get:function(){return r}});let a=l(2115);function r(e,t){let l=(0,a.useRef)(null),r=(0,a.useRef)(null);return(0,a.useCallback)(a=>{if(null===a){let e=l.current;e&&(l.current=null,e());let t=r.current;t&&(r.current=null,t())}else e&&(l.current=s(e,a)),t&&(r.current=s(t,a))},[e,t])}function s(e,t){if("function"!=typeof e)return e.current=t,()=>{e.current=null};{let l=e(t);return"function"==typeof l?l:()=>e(null)}}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)}},e=>{e.O(0,[354,766,441,964,358],()=>e(e.s=57)),_N_E=e.O()}]);